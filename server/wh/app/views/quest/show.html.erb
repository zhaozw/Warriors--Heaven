<html>
<head>
</head>
<script src="/javascripts/jquery-1.3.2.js"></script>
<script>
var g_data;
function doAction(action_name){
//	alert(action_name);
	$.ajax({
			type: "post",
			url: "/quest/doAction"+"?t="+ new Date().getTime(),
			data: {
				quest: '<%=@quest_name %>',
				action1: action_name,
				sid: '<%=@sid%>',
				authenticity_token:window._token
			}, 
			dataType: 'json',
			success: function(data, textStatus){
				  // alert( "Data Saved: " + data +","+ textStatus);
			//	$("#memopad").css("display", "block");
			 //  $("#result").html( $("#result").html()+data);
			 //$("#result").attr("scrollTop",$("#result").attr('scrollHeight'));
			g_data = data;
		
			if (data.msg)
				showTextWithTimer(data.msg);
			else
				apply();
			//alert(data.progress);
			//alert($("#pro_left"));
	
		
			//hasMemo=1;
			},
			error: function(xhr, textStatus, errorThrow){
				//alert("error"+errorThrow+","+textStatus+","+xhr.responseText);
			}
	});
}
function apply(){
	data = g_data;
		 if (data.room)
			 		 $("#room").html(data.room);
			 if (data.actions){
				$(".action_button").remove();
				 s = "";
				// alert(data.actions.length);
				for (i=0;i < data.actions.length;i++){
					a = data.actions[i];
					// alert (a.dname);
					s+="<button type='button' class='action_button' style=\"font-size:12pt;padding:0;\" onclick=\"doAction('"+a.name+"')\">"+a.dname+"</button>";
				}
				// alert("s="+s);
				$("div#action_list").html(s);
			}
			if (data.script)
				eval(data.script)
			$("#pro_left").css("width", data.progress+"px");		
}
	var line_number = 0;
	var TextArray=[];
	var timer;
	var container;
	function showTextWithTimer(msg){
		if (!msg || msg.length==0)
			return;
		// alert(msg);
	//	container = ele;
		line_number = 0;
		TextArray = [];
		reg = /<div([\s\S])*?div>/ig;
		while ((res = reg.exec(msg)) != null)  
		{  
  			// alert(res[0]);
			TextArray.push(res[0]);
		}  
	//	res = reg.exec(msg);
	//	alert(res);
		
		
	 //	TextArray = msg.split("<div");
	//	alert("====>"+TextArray);
		if (timer)
			clearInterval(timer);
		timer = setInterval('onTimer();', 1000);
		$(".action_button").attr("disabled", "disabled");
	}
	
	function onTimer(){
		if (line_number >= TextArray.length){
			clearInterval(timer);
			line_number = 0;
			$(".action_button").removeAttr("disabled");
			apply();
			return;
		}
	 	$("#result").html( $("#result").html()+TextArray[line_number]);
		line_number +=1;
		$("#result").attr("scrollTop",$("#result").attr('scrollHeight'));
	}

</script>
<body style="background:transparent;background-color:transparent;width:320px;margin:0;padding:0;border:0px solid red;">
<div id="bg" style="z-index:-1;position:absolute;left:0;top:0;width:320px;height: 430px;">
	<img id="bg" src="<%=@quest.bgimage%>" style="margin:10 0;height:480px;"/>
</div>
<div id="main" style="display:none;background:transparent;background-color: transparent;margin:25px;">
	<div >
		<span style="font-weight:bold;font-size:18pt;">
			Quest
		</span>
		<img src="/images/line1.png">
	</div>
	<div id="title" style="margin-top:10px;">
		<img src="<%=@quest.logo %>" style="border:0px;width:60px;float:left;" />
		
		<div id="desc" style="margin-left:65px;padding-top:5px;border:0px solid red;">
			<span><%=@quest.dname %></span><br/>
			<span style="font-color:yellow; font-size:9pt;height:10px;">
				<%=@quest.desc%>
			</span>
		</div>
	</div>
	<div style="clear:both"></div>
	<!-- progress -->
	<div>
	<div style="float:left;font-size:9pt;">达成度:</div>
	<div style="overflow:hidde;margin-top:6;float:left;border:1px solid #333333;width:100px;background:#999999;">
		<div id="pro_left" style="float:left;background:green;height:6px;width:<%=@quest.data[:progress] %>px;"></div>
		<div id="pro_right" style="background:transparent;height:6px;width:<%=100-@quest.data[:progress].to_i %>px;"></div>
	</div>
	</div>
	<div style="clear:both"></div>
	<div id="room" style="background:transparent;background-color:transparent;overflow:auto;max-height:70px;">
		<%=@quest.room%>
	</div>
	
	<div id="action_list">
		<% if @quest.action_list
			for action in @quest.action_list
		 %>
		<button type='button' class='action_button' style="font-size:12pt;padding:0;" onclick="doAction('<%=action[:name] %>')"><%=action[:dname] %></button>
		<% end 
		end
		%>
		
	</div>
	<div style="z-index:1;border:0px solid green;margin-left:-10px;margin-top:-10px;"> 
		<p><img src="/images/line1.png"></p>
	</div>
	<div id="result" style="margin-top:-10px;z-index:10;height:170px;overflow-y:auto;font-size:10pt;">
	<%=@quest.room_welcome if @quest.room_welcome %>
	</div>
</div>

</body>
</html>

<script>
proccess();
var v = setInterval('proccess();',500);
function proccess(){
	//alert($("img#bg")[0].width);
	if ($("img#bg")[0].width>300){
		$("div#main").css("display", "block");
		clearInterval(v);
		// alert("load complete");
	}
//	else
//		setInterval('proccess();',100);
		
}
		// $("#pro_left").css("width", <%=@quest.data[:process] %>+"px");
// alert("dfs");
</script>