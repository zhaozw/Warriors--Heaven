<html>
<head>
</head>
<script src="/javascripts/jquery-1.3.2.js"></script>
<script>
function doAction(action_name){
//	alert(action_name);
	$.ajax({
			type: "post",
			url: "/quest/doAction"+"?t="+ new Date().getTime(),
			data: {
				quest: '<%=@quest_name %>',
				action1: action_name,
				sid: '<%=@sid%>',
				authenticity_token:window._token
			}, 
			dataType: 'json',
			success: function(data, textStatus){
			//	 alert( "Data Saved: " + data +","+ textStatus);
			//	$("#memopad").css("display", "block");
			 //  $("#result").html( $("#result").html()+data);
			 //$("#result").attr("scrollTop",$("#result").attr('scrollHeight'));
			showTextWithTimer(data.msg);
			//alert(data.progress);
			//alert($("#pro_left"));
			$("#pro_left").css("width", data.progress+"px");
		
			//hasMemo=1;
			},
			error: function(xhr, textStatus, errorThrow){
				alert("error"+errorThrow+","+textStatus+","+xhr.responseText);
			}
	});
}
	var line_number = 0;
	var TextArray=[];
	var timer;
	var container;
	function showTextWithTimer(msg){
		if (!msg || msg.length==0)
			return;
		// alert(msg);
	//	container = ele;
		line_number = 0;
		TextArray = [];
		reg = /<div([\s\S])*?div>/ig;
		while ((res = reg.exec(msg)) != null)  
		{  
  			// alert(res[0]);
			TextArray.push(res[0]);
		}  
	//	res = reg.exec(msg);
	//	alert(res);
		
		
	 //	TextArray = msg.split("<div");
	//	alert("====>"+TextArray);
		if (timer)
			clearInterval(timer);
		timer = setInterval('onTimer();', 1000);
	}
	
	function onTimer(){
		if (line_number >= TextArray.length){
			clearInterval(timer);
			line_number = 0;
			return;
		}
	 	$("#result").html( $("#result").html()+TextArray[line_number]);
		line_number +=1;
		$("#result").attr("scrollTop",$("#result").attr('scrollHeight'));
	}

</script>
<body style="background:transparent;background-color:transparent;width:320px;margin:0;padding:0;border:0px solid red;">
<div id="bg" style="z-index:-1;position:absolute;left:0;top:0;width:320px;height: 430px;">
	<img id="bg" src="<%=@quest.bgimage%>" style="margin:10 0;height:480px;"/>
</div>
<div id="main" style="display:none;background:transparent;background-color: transparent;margin:25px;">
	<div >
		<span style="font-weight:bold;font-size:18pt;">
			Quest
		</span>
		<img src="/images/line1.png">
	</div>
	<div id="title" style="margin-top:10px;">
		<img src="<%=@quest.logo %>" style="border:0px;width:60px;float:left;" />
		
		<div id="desc" style="margin-left:65px;padding-top:5px;border:0px solid red;">
			<span><%=@quest.dname %></span><br/>
			<span style="font-color:yellow; font-size:9pt;height:10px;">
				<%=@quest.desc%>
			</span>
		</div>
	</div>
	<div style="clear:both"></div>
	<!-- progress -->
	<div>
	<div style="float:left;font-size:9pt;">达成度:</div>
	<div style="overflow:hidde;margin-top:6;float:left;border:1px solid #333333;width:100px;background:#999999;">
		<div id="pro_left" style="float:left;background:green;height:6px;width:0px;"></div>
		<div id="pro_right" style="background:transparent;height:6px;width:100px;"></div>
	</div>
	</div>
	<div style="clear:both"></div>
	<div id="room" style="background:transparent;background-color: transparent;">
		<%=@quest.room%>
	</div>
	
	<div id="action_list">
		<% for action in @quest.action_list %>
		<button type='button' onclick="doAction('<%=action[:name] %>')"><%=action[:dname] %></button>
		<% end %>
	</div>
	<div style="border:0px solid green;margin-left:-10;"> 
		<p><img src="/images/line1.png"></p>
	</div>
	<div id="result" style="height:180px;overflow-y:auto;font-size:10pt;">
	</div>
</div>

</body>
</html>

<script>
proccess();
var v = setInterval('proccess();',500);
function proccess(){
	//alert($("img#bg")[0].width);
	if ($("img#bg")[0].width>300){
		$("div#main").css("display", "block");
		clearInterval(v);
		// alert("load complete");
	}
//	else
//		setInterval('proccess();',100);
		
}

// alert("dfs");
</script>